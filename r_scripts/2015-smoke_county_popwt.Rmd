---
title: "Western US County Population-Weighting PM"
author: "Ryan Gan"
date: "2018-01-17"
output: html_document
---

## Purpose

This markdown file contains descriptions and code for estimating daily county-level population-weighted PM ~2.5~ values from gridded estimates of PM ~2.5~. Gridded estimates were calculated using geographically-weighted ridge regression (GWR) and krigging.

### Setup

Loading tidyverse for general data wrangling and plotting; netcdf4 for accessing PM data stored in .nc file; sf package for spatial calculations.

```{r setup, include=F}
# libraries used
library(tidyverse)
library(ncdf4)

# general knitr options
knitr::opts_chunk$set(fig.width = 7, fig.height = 5, 
                      message = F, warning = F)
```

## Extracting PM values from netcdf files

Connecting to PM netcdf file and printing summary. NetCDF file is a 3-dimentional grid of latitude, longitude, and time. It also contains values for GWR, kriging, and background estimates of PM (estimated via GWR).

```{r connect_nc}
# open connection to netcdf 
smk_2015_nc <- nc_open("./data/smoke/2015-smoke_pm_wus.nc")
# print summary
smk_2015_nc
```

Extracting grid points (matrix) and setting as vectors. When using the as.vector function on matrix values from a netcdf, it will go row by row (left to right, then top to bottom). Plotting the latitude and longitude coordinates to check centroids of grid.

```{r assemble_grid}
# extract longitude as a vector
lon <- as.vector(t(ncvar_get(smk_2015_nc, "glons")))
# extract latitude as a vector
lat <- as.vector(t(ncvar_get(smk_2015_nc, "glats")))
# extract date as a vector (format yyyymmdd)
date <- as.vector(ncvar_get(smk_2015_nc, "dates"))
# kriging values
krig_pm <- ncvar_get(smk_2015_nc, "kPM")

# id sequence
id <- 1:20838

# bind together and plot to see where grids are
id_location <- as_data_frame(cbind(id, lon, lat))

# first 100 values 
id_first100 <- id_location[1:100,]

ggplot(id_first100, aes(x=lon, y=lat)) +
  geom_text(aes(label = id), size = 2.5) +
  xlim(min(lon), max(lon)) +
  ylim(min(lat), max(lat))

# last 100
id_last100 <- id_location[20738:20838,]

ggplot(id_last100, aes(x=lon, y=lat)) +
  geom_text(aes(label = id), size = 2.5) +
  xlim(min(lon), max(lon)) +
  ylim(min(lat), max(lat))

```


