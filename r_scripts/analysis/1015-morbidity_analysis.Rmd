---
title: "Exploring County-Level Population-Weighted PM~2.5~"
author: "Ryan Gan"
date: "2018-02-26"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

## Introduction
I have population-weighted PM~2.5~ values provided by Kate and air temperature at 2 meters values downloaded from the NCEP/NCARR reanalysis data sets. This seemed like a reasonable height; other options would be surface temperature. Both estimates were population-weighted to the county level using 2015 population density estimates from SEDAC (version 4). Right now, I only have counties for the Western US, but could produce estimates for the entire continental US.

I have PM~2.5~ estimates from 2006-2015. I will only use 2010 to 2015, which are the years I have health outcomes data. I only downloaded the 2010 to 2015 temperature estimates.

Setting up R Notebook knit options and libraries
```{r kniter_opt}
# knitr options
knitr::opts_chunk$set(fig.height = 6, fig.width = 8, fig.align = "center",
                      progress = F, message = F, warning = F, echo=F,
                      results = "asis")
# libraries
library(tidyverse)
library(lme4) # loading lme4 mixed model package
library(splines) # splines package
```

Setting up dark color theme.
```{r ggtheme}
ryan_theme <- theme(panel.background = element_rect(fill = "black", 
          colour = "black", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.2, colour = "white"),
        panel.grid.minor = element_line(size = 0.1, color = "white", 
                                        linetype = "dotted"),
        plot.background = element_rect(fill = "#141e30", colour="#141e30",
                                       size = 0.5, linetype = "solid"),
        text = element_text(colour = "white"),
        axis.text = element_text(colour = "white"),
        strip.background = element_blank(),
        strip.text = element_text(colour="white"),
        legend.background = element_blank(),
        legend.key = element_blank())
```

## Data Import and Wrangle
Read in time series dataframe that contains Colorado and Washington counts and PM~2.5~ concentrations.

```{r data_import}
ts <- read_csv("../../data/health/1015-morbidity_pm_ts.csv") %>% 
  filter(!is.na(pm_krig)) %>% 
  mutate(month = lubridate::month(date),
         year = lubridate::year(date),
         season = case_when(month %in% c(12, 1, 2) ~ "winter",
                            month %in% c(3:5) ~ "spring",
                            month %in% c(6:8) ~ "summer",
                            month %in% c(9:11)~ "fall"))
```

Same-day association.
```{r}
spl <- ns(ts$date, df = 35)
# random effects mod
mod <- glmer(asthma ~ smoke_wave + temp_f +  
               (1|fips) + offset(log(population)), 
             family = "poisson"(link="log"), data = ts,
             control = glmerControl(optimizer = "bobyqa"))

summary(mod)
summary(ts)

# glm mod
mod2 <- glm(cvd ~ smoke_wave + temp_f + state + month + year + fips +
              offset(log(population)), 
            family = "poisson"(link="log"), data = ts)

summary(mod2)
```

Predict time-series.
```{r}
# define degrees of freedom
spl_df <- 30:35

# fit spline by date
spline_fits <- spl_df %>% 
  map_dfr(function(df_val){
    date <- ts$date
    # run spline based on date sequence
    spl <- ns(date, df = df_val)
    # model gwr_smoke units regressed on the spline
    pm_mod <- lm(pm_krig ~ spl, data = ts)
    # estimated predicted values based on the spline and bind with dates
    pm_pred <- predict(pm_mod, type="response")
    # rep df val by length of prediction
    degree_freedom <- rep(df_val, length(pm_pred))
    # rep aic val by lenth of prediction 
    aic <- round(rep(AIC(pm_mod), length(pm_pred)),2)
    # join with total_ed 
    plot_df <- ts %>% 
      select(date, fips, pm_krig) %>% 
      cbind(pm_pred, degree_freedom, aic)
  } # end function
) # end map 
```

Plotting fits of splines to see how well spline estimates track PM~2.5~ exposure series.

```{r spline_fit_plot}
spline_subset <- spline_fits %>% 
  filter(degree_freedom %in% (5:10))


ggplot(data = spline_fits, aes(x=date, y=pm_krig)) +
  geom_point(colour = "#24c6dc", size = 0.2) +
  geom_line(aes(x=date, y=pm_pred), colour = "#ff00cc") +
  facet_wrap(~degree_freedom) +
  ggtitle("Spline fit of PM2.5 by degrees of freedom") +
  xlab("2010-2015") +
  ylab("PM2.5 ug/m^3") +
  ryan_theme
```

I think I need to move the more complicated models over to the server, save the output, and work with that.

Denver County
```{r}
# denver county complete case
denver <- ts %>% filter(fips == "08031") %>% 
  mutate(month = lubridate::month(date)) %>% 
  filter(complete.cases(.))

# spline
spl <- ns(denver$date, df = 30)
# predict pm
pm_mod <- lm(pm_krig ~ spl, data = denver)
# predicted pm
pm_pred <- predict(pm_mod, type="response")
# bind to denver
denver_pred_pm <- denver %>% 
  cbind(., pm_pred)

ggplot(denver_pred_pm, aes(x=date, y=pm_krig)) +
  geom_point() +
  geom_line(aes(x=date, y=pm_pred), color = "red")

# simple mod
mod <- glm(resp ~ pm_krig + smoke5 + pm_krig*smoke5 + temp_f + spl, 
           family="poisson"(link="log"), data = denver)
summary(mod)

mod2 <- glm(resp ~ pm_krig + spl, 
           family="poisson"(link="log"), data = denver)
summary(mod2)
```

```{r larimer}
chelan <- ts %>% filter(fips == "53007") %>% 
  mutate(month = lubridate::month(date)) %>% 
  filter(complete.cases(.)) %>% 
  filter(year == 2012)

# spline
spl <- ns(chelan$date, df = 13)
# predict pm
pm_mod <- lm(pm_krig ~ spl, data = chelan)
# predicted pm
pm_pred <- predict(pm_mod, type="response")
# bind to denver
c_pred_pm <- chelan %>% 
  cbind(., pm_pred)

ggplot(c_pred_pm, aes(x=date, y=pm_krig)) +
  geom_point() +
  geom_line(aes(x=date, y=pm_pred), color = "red")

# simple mod
mod <- glm(asthma ~ smoke_wave + temp_f + as.factor(month), 
           family="poisson"(link="log"), data = chelan)
summary(mod)

ggplot(chelan, aes(x=date, y=resp)) +
  geom_point()
```

Problem Identified: When I include the full year, there are going to be PM levels that meet a definition above PM estimate - background that is not really due to smoke. Solution to this would be to look only in certain months (i.e. wildfire season), or include interaction term where a binary smoke variable is created (I've added additional month criteria).

I think I might need to go with the timestrat casecross design.
