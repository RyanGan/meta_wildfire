---
title: "2010-2015 Washington and Colorado Interaction Distributed Lag"
author: "Ryan Gan"
date: '2018-02-26'
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

## Introduction

This document contains preliminary results evaluating the association between smoke PM~2.5~ and cardiorespiratory hospitalizations admitted through the emergency room (ER) for Colorado and Washington from 2010 to 2015. I only used the inpatient CHARS data and the Colorado hospital discharge data as I think they are similar enough to combine in analyses. I did not include CHARS observation data and it can lead to over counting. 

I have population-weighted PM~2.5~ values provided by Kate and air temperature at 2 meters values downloaded from the NCEP/NCARR reanalysis data sets. This seemed like a reasonable height; other options would be surface temperature. Both estimates were population-weighted to the county level using 2015 population density estimates from SEDAC (version 4). Right now, I only have counties for the Western US, but could produce estimates for the entire continental US.

I have PM~2.5~ estimates from 2006-2015. I will only use 2010 to 2015, which are the years I have health outcomes data. I only downloaded the 2010 to 2015 temperature estimates.

Setting up R Notebook knit options and libraries. I'm suppressing code and messages to make this document easier to read.
```{r kniter_opt, include = F}
# knitr options
knitr::opts_chunk$set(fig.height = 6, fig.width = 8, fig.align = "center",
                      results = "asis", message=F, warning=F, echo=F)
# libraries
library(tidyverse)
```

```{r ggtheme}
# Setting up dark color theme.
ryan_theme <- theme(panel.background = element_rect(fill = "black", 
          colour = "black", size = 0.5, linetype = "solid"),
        panel.grid.major = element_line(size = 0.2, colour = "white"),
        panel.grid.minor = element_line(size = 0.1, color = "white", 
                                        linetype = "dotted"),
        plot.background = element_rect(fill = "#141e30", colour="#141e30",
                                       size = 0.5, linetype = "solid"),
        text = element_text(colour = "white"),
        axis.text = element_text(colour = "white"),
        strip.background = element_blank(),
        strip.text = element_text(colour="white"),
        legend.background = element_blank(),
        legend.key = element_blank())
```

## Environmental Data

Importing population-weighted environmental data of PM~2.5~ estimated using kriging and reanalysis temperature data for counties in the Western US.

```{r pm_import}
# read pm values
county_pm_ts <- read_csv("../../data/smoke/1015-county_popwt_pm.csv")
```

Calculating mean and median values of PM~2.5~, background PM~2.5~, HMS proportion of county covered by smoke, and temperature in degrees Fahrenheit.

```{r state_avg}
# state averages
avg_state <- county_pm_ts %>% 
  group_by(state, date) %>% 
  summarise(pm_mean = mean(pm_krig), pm_med = median(pm_krig), 
            bg_pm_mean = mean(bg_pm), bg_pm_med = median(bg_pm),
            hms_mean = mean(hms), hms_med = median(hms), 
            temp_mean = mean(temp_f), temp_med = median(temp_f))
```

### PM~2.5~

Plot of county-specific PM~2.5~ time series for each state in the Western US from 2010 to 2016. The red line is the average of the county seasonal background PM~2.5~. 

```{r state_pm_plot}
# plot
plot <- ggplot(county_pm_ts, aes(x=date,y=pm_krig, group = fips)) +
  geom_line(color = "#93f9b9") +
  geom_line(data = avg_state, aes(x=date,y=bg_pm_mean, group=NA), 
            color = "red") +
  facet_wrap(~state) +
  ylab("PM2.5 ug/m^3") +
  xlab("Date") +
  ggtitle("PM2.5 for each county by state") +
  ryan_theme

print(plot)
```

I think it looks like the extreme peaks in the spring/summer/fall months are associated with fire smoke. The extreme peaks in PM~2.5~ for Washington look like they correspond with the 2012 Wenatchee Complex fire and the 2015 Pacific Northwest Fires. For Colorado, I notice an increase in PM~2.5~ around the same time as the High Park Fire (although this is not nearly as pronounced as other states). It looks like the big peak in Nevada corresponds with the Rim Fire in August 2013. Oregon PM~2.5~ corresponds with peaks in 2013 Douglas-Complex fire. It's likely that peaks >75 ug/m^3^ in California, Montana, Idaho, New Mexico are associated with fire smoke too. As for Arizona, I'm not sure since they experience dust storms too. Unsure about Utah too since they have pretty bad air quality in Salt Lake during the Winter.

#### Problem/Question

This raised a question for me where before we've modeled specific states that we knew experienced fire smoke for a limited time-frame. This is important for my binary classifiers of smoke, where usually I just said if estimated PM~2.5~ - background PM~2.5~ was >0, >5, >10, or >15 ug/m^3^ and at least 50% of the county was impacted by smoke using the Hazard Mapping System, then smoke impacted a county. I've now added the additional criteria that this condition needs to be met from March to October. This may be too simplistic to define a binary smoke event.

Another problem is that the continuous variable of estimated PM - background PM is no longer even a decent indication of PM~2.5~ due to wildfire smoke, and probably not appropriate to use. I think an interaction between PM~2.5~ and a binary classifier of smoke is still a good approach.

Can information on temperature and HMS be used to help inform prediction of when a county's air quality is impacted by smoke? Let's look.

### HMS Smoke in Column

For HMS proportion, I population-weighted the binary (0 or 1) grid cells for each county, which should give me an estimate of the proportion of the county with smoke in the atmospheric column (assessed via HMS) and weighted by population density.
```{r hms_plot}
plot <- ggplot() +
  geom_line(data = avg_state, aes(x=date,y=hms_mean, group=NA), 
            color = "#6a82fb") +
  facet_wrap(~state) +
  ylab("Mean proportion smoke cover)") +
  xlab("Date") +
  ggtitle("Mean proportion of county smoke cover by state") +
  ryan_theme

print(plot)
```

I'm struggling a bit with what the mean of the weighted county proportions covered by smoke mean exactly, but plotting each FIPS time series wasn't really helpful. Here is how I may interpret it: the higher the proportion, the more of the state with smoke in the atmospheric column for that day. So values of 1 would suggest the whole state has some detectable smoke overhead. It looks like most smoke occurs in times other than that winter months.

### Temperature in F

Plotting temperature in F for each county in each state. Red line is the mean temperature for counties in the state.

```{r temp_plot}
plot <- ggplot(county_pm_ts, aes(x=date,y=temp_f, group = fips)) +
  geom_line(color = "#7f00ff") +
  geom_line(data = avg_state, aes(x=date,y=temp_mean, group=NA), 
            color = "red") +
  facet_wrap(~state) +
  ylab("Degrees F") +
  xlab("Date") +
  ggtitle("Temperature for each county by state") +
  ryan_theme

print(plot)
```
Temperature trends have a nice period trend to them. 

I think I could probably use HMS proportion. Maybe county with >0.25 smoke and PM~2.5~ estimate - background > x as an indicator of a county affected by smoke at ground-level?

#### Research/Analysis Idea

Can we use PM~2.5~, temperature, and HMS smoke to predict a county affected by smoke on a particular day? We could use truth as official state air quality warnings for smoke. I know Colorado has these. I'm sure other states do too. Could use a small training set of days in counties known to be impacted by smoke from the major fires above, build a classification model of some sort, then use this model to predict binary smoke classifier across the regions and time-series. 

## Hospitalization Emergency Room Data

Read in time series data frame that contains Colorado and Washington counts and PM~2.5~ concentrations.

```{r morbidity_data_import}
ts <- read_csv("../../data/health/1015-morbidity_pm_ts.csv") %>% 
  filter(!is.na(pm_krig)) %>% 
  mutate(month = lubridate::month(date),
         year = lubridate::year(date),
         season = case_when(month %in% c(12, 1, 2) ~ "winter",
                            month %in% c(3:5) ~ "spring",
                            month %in% c(6:8) ~ "summer",
                            month %in% c(9:11)~ "fall"))
```

Aggregating Washington and Colorado counts of inpatient visits admitted through the emergency room/department for respiratory and cardiovascular disease outcomes (CVD) and plotting time series by state and outcome.

```{r state_resp_cvd}
# dataframe
resp_cvd_ts <- ts %>% 
  group_by(date, state) %>% 
  summarize(resp = sum(resp), cvd = sum(cvd)) %>% 
  gather("outcome", "n", resp:cvd) %>% 
  mutate(group = paste0(state, ": ", outcome))

# plot 
plot <- ggplot(resp_cvd_ts, aes(x=date,y=n)) +
  geom_point(color = "#00dbde", size = 0.1) +
  facet_wrap(~group) +
  ryan_theme

  
print(plot)  
```

I have one more year of claims data from Colorado compared to Washington. Counts are slightly higher for both CVD and respiratory outcomes in Washington compared to Colorado, but the population is also higher. I've presented rates in previous documents, and in summary, I don't think there is a huge difference in rates by states. Another interesting trend is that for both states, on some New Year's Eve, the numbers drop to levels that aren't believable, but when you look at New Year's Day, there are peak spikes. I kind of think that maybe people that go to the ER on New Year's Eve may be counted towards the next years counts. There may be a ligit reason for this. Maybe it's easier to bill on a next years cycle or something, admin staff in charge of logging/billing off for the night? 

Anyways, now that I have a full year I probably need to adjust for this now that I think about it...

I'm going to present results from both a time-stratified case-crossover design and the time-series design.

## Time Series Results

Starting off by presenting time series results. I'm denoting plots as TS for time series or CC as case-crossover so that you can keep the results clear.

### Same-Day Association Results

I evaluated the association between binary smoke classifiers and cardiopulmonary outcomes in a time-series model. I ran my usual cutoffs of 0, 5, 10, and 15 ug/m^3^ above the difference between the estimated PM~2.5~ from the kriging model and seasonal background. I do not use HMS in this definition for the same day because I forgot to update these models; they are in a seperate script from the distributed lag model. I've also include smoke-wave. I had the additional criteria of occuring in the month of March through Octobe.

I ran mixed effect Poisson models adjusting for temperature, month, year, weekend, and state. Models treated county as a random effect, and I included a population offset. I ran this on the ozone cluster; importing results here.

```{r same_day_results}
# outcome order
out_order <- c("resp", "asthma", "copd", "acute_bronch", "pneum", "cvd",
               "arrhythmia", "cereb_vas", "hf", "ihd", "mi")
ex_order <- c("smoke0", "smoke5", "smoke10", "smoke15", "smoke_wave")

# import same-day results
same_day_results <- read_csv(paste0("../../data/health/",
  "1015-ts_binary_smoke_results.csv")) %>% 
  filter(outcome != "cardiopulm_n") %>% 
  mutate(outcome = forcats::fct_relevel(outcome, out_order),
         exposure = forcats::fct_relevel(exposure, ex_order),
         group = as.factor(if_else(outcome %in% out_order[1:5],
          "respiratory", "cardiovascular")))
# plot
plot <- ggplot(data=same_day_results, aes(x=outcome, y = rr, colour = group)) +
  geom_point() +
  geom_errorbar(aes(ymin=lower95, ymax=upper95), width = 0.3) +
  scale_color_manual(values = c("#9cecfb", "#ff00cc")) +
  geom_hline(yintercept = 1, linetype = "dashed", colour = "red") +
  facet_wrap(~exposure, scales = "free_y") +
  ylab("Rate Ratio: Smoke Exposure") +
  xlab("Outcome") +
  ggtitle(paste0("TS: Association between binary smoke and ED admissions")) +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 90, hjust=0.95, vjust = 0.75))

print(plot)
```

For these binary results, I'm going to consider the smoke-wave variable to be the most specific (we should test the sensitivity/specificity). There is an increased risk for both asthma and COPD hospitalizations. The most ocnsistent signal I see is with COPD. Asthma fluctuates between definitions, but smoke wave shows an association. This could be that the same-day association may miss people who end up needing to go the following day (early morning or next day) following a smoke day. 

Note, I saw very similar associations with the continuous smoke PM~2.5~ variables for 2015 Washington and Colorado for both the time-series study and the time-stratified case-crossover studies I used as a sensitivity analysis. Therefore, I'm slightly more confident that perhaps our Washington 2012 study was the outlier where maybe smoke levels were so high that there was indeed an association on the same day. Perhaps a better way to say this is that I think it's very likely that the risk is increased for asthma on the same day of smoke exposure, but it's also very likely that it may take a day or two for the effects of smoke exposure to manifest. I suspect this is a very likely scenario for mortality too.

### Distributed Lag Results from Time Series

Evaluating the cumulative lagged effect of PM~2.5~ from smoke and not from smoke up to a week of smoke exposure with distributed lag models with an interaction. Same thing as above. These random-effects models were compuationally-expensive to run, so I ran them on the ozone server in parallel and I'm importing the results here. I've also only decided to evaluate distributed lag results for PM~2.5~ interacted with binary smoke smoke10_hms, smoke15_hms. Here, I define the binary cutoff for smoke

```{r import_dl_results}
dl_results <- read_csv(paste0("../../data/health/",
  "1015-ts_dl_int_results-2018-03-19.csv")) %>% 
  filter(outcome != "cardiopulm_n") %>% 
  mutate(outcome = forcats::fct_relevel(outcome, out_order),
         group = as.factor(if_else(outcome %in% out_order[1:5],
          "respiratory", "cardiovascular")))
```

Association between lagged smoke > 10 ug/m^3^ and cardiopulmonary outcomes. I've included three basis functions in the model: the binary smoke indicator, PM~2.5~ on days with smoke, and PM~2.5~ on days without smoke. Models account for county as a random effect, temperature and weekend as a fixed effect, and a spline fit with 12 degrees of freedom fit to the date series in an attempt to account for unmeasured confounders that vary trends in the PM~2.5~ series. I included ounty population offsets as well. For each spline for the distributed lag effect, I've set the degrees of freedom/knots at 3 to allow for a flexible enough shape. Usually I pick the degrees of freedom based onlowest AIC, but I've never seen a shape that suggested anything more than a third-order polynomial (i.e. 5th order polynomials look like 3rd order).

#### Interaction by Smoke 10 Binary Indicator

Plotting the cumulative distributed lag association of PM~2.5~ interacted with binary smoke > 10 classifier and rate ratio. I'm going to plot the respiratory outcomes first so that the plots are easier to read.

##### Cumulative Effect of PM~2.5~ on Respiratory Outcomes

I've left out the binary smoke basis because I'm not sure if has a useful interpretation here when PM~2.5~ is included. I'm only going to look at the all respiratory, asthma, and COPD.

```{r dl_smk10_resp_results}
# filter to smoke 10 results
resp_cumulative_results <- dl_results %>% 
  filter(exposure == "smoke10_hms" & type == "cumulative" &
           outcome %in% c("resp", "asthma", "copd") & smoke != "smk") %>% 
  mutate(strata = ifelse(smoke == "pm_smk", "Smoke", "No Smoke"),
    outcome_full = case_when(outcome == "resp" ~ "Respiratory",
                             outcome == "asthma" ~ "Asthma",
                             outcome == "copd" ~ "COPD"),
    out_strata = factor(paste0(outcome_full, "\n ", strata), 
      levels = c("Respiratory\n No Smoke", "Respiratory\n Smoke",
                 "Asthma\n No Smoke", "Asthma\n Smoke",
                 "COPD\n No Smoke", "COPD\n Smoke")))

# plot
plot <- ggplot(resp_cumulative_results, aes(x=time, y=estimate)) +
  geom_line(colour = "#0ed2f7", size = 1) +
  geom_ribbon(aes(ymin = lower95, ymax = upper95), 
              fill = "#b2fefa", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~out_strata, ncol = 2, scales = "free_y") +
  ylab("Rate Ratio for a 10 ug/m^3in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("TS: Respiratory with smoke 10 as effect modifier") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

My quick take on these results with smoke 10 variable as an effect modifier is that variations in county-level PM~2.5~ when no smoke is present in the county are inversely associated with the rate of respiratory hospitalizations admitted through the emergency room. Although I'd interpret this as no association rather than a protective effect of increasing PM~2.5~ on population respiratory hospitalizations. On smoke days, a 10 ug/m^3^ increase in PM~2.5~ on the same day and the previous day or two of exposure is associated with an increase in the rate of COPD and respiratory hospitalizations. Asthma may take up to a week of prolonged increases in PM~2.5~ exposure on smoke days.

The difference in the lagged responses on smoke vs non-smoke is an odd observation. I'm going to look at cardiovascular outcomes and using the slightly more strict definition of a smoke day as the effect modifier.

##### Cumulative Effect of PM~2.5~ on Cardiovascular Outcomes

I've left out the binary smoke basis because I'm not sure if has a useful interpretation here when PM~2.5~ is included.

```{r dl_smk10_cvd_results}
# filter to smoke 10 results
cvd_cumulative_results <- dl_results %>% 
  filter(exposure == "smoke10_hms" & type == "cumulative" & smoke != "smk" &
    outcome %in% c("cvd", "arrhythmia", "cereb_vas", "hf", "ihd")) %>% 
  mutate(strata = ifelse(smoke == "pm_smk", "Smoke", "No Smoke"),
    outcome_full = case_when(outcome == "cvd" ~ "Cardiovascular",
                             outcome == "arrhythmia" ~ "Arrhythmia",
                             outcome == "cereb_vas" ~ "Cerebrovascular",
                             outcome == "hf" ~ "Heart Failure",
                             outcome == "ihd" ~ "Ischemic Heart Disease"),
    out_strata = factor(paste0(outcome_full, "\n ", strata), 
      levels = c("Cardiovascular\n No Smoke", "Cardiovascular\n Smoke",
                 "Arrhythmia\n No Smoke", "Arrhythmia\n Smoke",
                 "Ischemic Heart Disease\n No Smoke", 
                 "Ischemic Heart Disease\n Smoke",
                 "Heart Failure\n No Smoke", "Heart Failure\n Smoke",
                 "Cerebrovascular\n No Smoke", "Cerebrovascular\n Smoke")))

# plot
plot <- ggplot(cvd_cumulative_results, aes(x=time, y=estimate)) +
  geom_line(colour = "#ff00cc", size = 1) +
  geom_ribbon(aes(ymin = lower95, ymax = upper95), 
              fill = "#ff00cc", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~out_strata, ncol = 2, scales = "free_y") +
  ylab("Rate Ratio for a 10 ug/m^3in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("TS: Cardiovascular with smoke 10 as a modifier") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

There may be a lagged association of ischemic heart disease on non-smoke days following multiple days of elevated exposure. Nothing really with smoke PM~2.5~ except maybe a signal with stroke. 

#### Interaction by Smoke 15 Binary Indicator

Plotting the cumulative distributed lag association of the binary smoke > 15 classifier and rate ratio.

##### Cumulative Effect of PM~2.5~ on Respiratory Outcomes

```{r dl_resp_smk15_results}
# filter to smoke 10 results
resp_cumulative_results <- dl_results %>% 
  filter(exposure == "smoke15_hms" & type == "cumulative" &
           outcome %in% c("resp", "asthma", "copd") & smoke != "smk") %>% 
  mutate(strata = ifelse(smoke == "pm_smk", "Smoke", "No Smoke"),
    outcome_full = case_when(outcome == "resp" ~ "Respiratory",
                             outcome == "asthma" ~ "Asthma",
                             outcome == "copd" ~ "COPD"),
    out_strata = factor(paste0(outcome_full, "\n ", strata), 
      levels = c("Respiratory\n No Smoke", "Respiratory\n Smoke",
                 "Asthma\n No Smoke", "Asthma\n Smoke",
                 "COPD\n No Smoke", "COPD\n Smoke")))

# plot
plot <- ggplot(resp_cumulative_results, aes(x=time, y=estimate)) +
  geom_line(colour = "#0ed2f7", size = 1) +
  geom_ribbon(aes(ymin = lower95, ymax = upper95), 
              fill = "#b2fefa", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~out_strata, ncol = 2, scales = "free_y") +
  ylab("Rate Ratio for a 10 ug/m^3in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("Respiratory with smoke 15 as effect modifier") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

Similar associations as the smoke 10 except no association on smoke days with asthma.

##### Cumulative Effect of PM~2.5~ on Cardiovascular Outcomes

```{r dl_smk15_cvd_results}
# filter to smoke 10 results
cvd_cumulative_results <- dl_results %>% 
  filter(exposure == "smoke15_hms" & type == "cumulative" & smoke != "smk" &
    outcome %in% c("cvd", "arrhythmia", "cereb_vas", "hf", "ihd")) %>% 
  mutate(strata = ifelse(smoke == "pm_smk", "Smoke", "No Smoke"),
    outcome_full = case_when(outcome == "cvd" ~ "Cardiovascular",
                             outcome == "arrhythmia" ~ "Arrhythmia",
                             outcome == "cereb_vas" ~ "Cerebrovascular",
                             outcome == "hf" ~ "Heart Failure",
                             outcome == "ihd" ~ "Ischemic Heart Disease"),
    out_strata = factor(paste0(outcome_full, "\n ", strata), 
      levels = c("Cardiovascular\n No Smoke", "Cardiovascular\n Smoke",
                 "Arrhythmia\n No Smoke", "Arrhythmia\n Smoke",
                 "Ischemic Heart Disease\n No Smoke", 
                 "Ischemic Heart Disease\n Smoke",
                 "Heart Failure\n No Smoke", "Heart Failure\n Smoke",
                 "Cerebrovascular\n No Smoke", "Cerebrovascular\n Smoke")))

# plot
plot <- ggplot(cvd_cumulative_results, aes(x=time, y=estimate)) +
  geom_line(colour = "#ff00cc", size = 1) +
  geom_ribbon(aes(ymin = lower95, ymax = upper95), 
              fill = "#ff00cc", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~out_strata, ncol = 2, scales = "free_y") +
  ylab("Rate Ratio for a 10 ug/m^3in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("TS: Cardiovascular with smoke 15 as a modifier") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

Results are similar to the smoke 10 cutoff.

## Time-Stratified Case-Crossover Results

For these analyses, I've identified unique hospitalizations and created referent periods within the same month. I also further restricted the time periods to April and October to limit the observation period to wildfire season. We should discuss validity of this approach as a group. 

### PM~2.5~ Distributed Lag Results

Starting by looking at the cumulative effect of PM~2.5~ on cardiopulmonary outcomes over a one week lagged period. I make no attempt to parse out smoke vs non-smoke effects here. Also note that part of my motivation for restricting the time period to the wildfire season was that I was seeing inverse associations that didn't make sense here when I include the full year. It could have been that on very cold days, people stayed in or avoided PM exposure, where adjusting for temperature did not really help account for this. 

```{r cumulative_pm_cc}
# read data
cc_pm_dl <- read_csv("../../data/health/1015-cc_dl_pm_results.csv") %>% 
  filter(type == "cumulative")
```

#### Cumulative Effect of PM~2.5~ on Respiratory Outcomes

```{r resp_pm_cc1}
# filter to respiratory
resp_cumulative_results <- cc_pm_dl %>% 
  filter(outcome %in% c("resp", "asthma", "copd", "acute_bronch", "pneumonia"))

# plot cumulative effect
plot <- ggplot(resp_cumulative_results, aes(x=time, y=odds_ratio)) +
  geom_line(colour = "#0ed2f7", size = 1) +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), 
              fill = "#0ed2f7", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~outcome, ncol = 2, scales = "free_y") +
  ylab("Odds Ratio: 10 ug/m^3 in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("CC: Cumulative Effect of PM2.5 on Respiratory") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

A 10 ug/m^3^ increase in county-level population-weighted PM~2.5~ increases the risk for a respiratory, asthma, and COPD roughtly 2 to 5 days after elevated exposure. Keep in mind the count-level assigned PM~2.5~. I think that could be an important bias/caveat with interpretation.

#### Cumulative Effect of PM~2.5~ on Cardiovascular Outcomes

```{r cvd_pm_cc2}
# filter to cardiovascular
cvd_cumulative_results <- cc_pm_dl %>% 
  filter(outcome %in% c("cvd", "arrhythmia", "cereb_vas", "hf", "ihd", "mi")) 

# plot
plot <- ggplot(cvd_cumulative_results, aes(x=time, y=odds_ratio)) +
  geom_line(colour = "#ff00cc", size = 1) +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), 
              fill = "#ff00cc", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~outcome, ncol = 2, scales = "free_y") +
  ylab("Odds Ratio: 10 ug/m^3in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("CC: Cumulative Effect of PM2.5 on Cardiovascular") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

Looks like there is a cumulative effect in a 10 ug/m^3^ increase PM~2.5~ on all cardiovascular observatiosn maybe 4 to 5 days over repeated elevated exposure. Perhaps ischemic heart disease (myocardial infarction) and arrythmia could be some of the specific diagnoses that may explain this bump.

### Smoke 10 Distributed Lag Results

```{r cumulative_smk10_cc}
# read data
cc_smk10_dl <- read_csv("../../data/health/1015-cc_dl_smk10_results.csv") %>% 
  filter(type == "cumulative")
```

#### Cumulative Effect of PM~2.5~ on Respiratory Outcomes

```{r resp_pm_cc2}
# filter to respiratory
resp_cumulative_results <- cc_smk10_dl %>% 
  filter(outcome %in% c("resp", "asthma", "copd", "acute_bronch", "pneumonia"))

# plot cumulative effect
plot <- ggplot(resp_cumulative_results, aes(x=time, y=odds_ratio)) +
  geom_line(colour = "#0ed2f7", size = 1) +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), 
              fill = "#0ed2f7", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~outcome, ncol = 2, scales = "free_y") +
  ylab("Odds Ratio: 10 ug/m^3 in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("CC: Cumulative Effect of Smoke 10 on Respiratory") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

Looks like cumulative exposure of a county impacted by smoke where the difference above background is >10 is associated with an increased risk in respiratory hospitalization following 3 days of repeated exposure. Asthma and COPD-specific outcomes may take a couple more days to manifest. The signal is very strong for asthma. One way to interpret this could be that there is no association with smoke exposure on the day of, but perhaps days of smoke could lead to an increase in risk. Perhaps explained by people staying indoors or taking precautions to reduce exposure.

#### Cumulative Effect of PM~2.5~ on Cardiovascular Outcomes

```{r cvd_pm_cc1}
# filter to cardiovascular
cvd_cumulative_results <- cc_smk10_dl %>% 
  filter(outcome %in% c("cvd", "arrhythmia", "cereb_vas", "hf", "ihd", "mi")) 

# plot
plot <- ggplot(cvd_cumulative_results, aes(x=time, y=odds_ratio)) +
  geom_line(colour = "#ff00cc", size = 1) +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), 
              fill = "#ff00cc", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~outcome, ncol = 2, scales = "free_y") +
  ylab("Odds Ratio: 10 ug/m^3in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("CC: Cumulative Effect of Smoke 10 on Cardiovascular") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

Similar to continous PM~2.5~, it looks it may take 3 to 4 days for an effect with CVD to manifest. Similarly, it might be explained mostly by IHD (MI) and arrythmia events.

In the interest of space, I'm not going to present the other binary smoke cutoffs.

### Distributed Lag Interaction Smoke10 x PM~2.5~

Plotting the distributed lag association for smoke PM~2.5~ and non-smoke PM~2.5~ in the same way I plotted the time-series results.

```{r read_dl_int_cc}
# read interaction models
cc_dl_int <- read_csv("../../data/health/1015-cc_dl_int_results.csv") %>% 
  filter(type == "cumulative")
```


##### Cumulative Effect of PM~2.5~ on Respiratory

```{r dl_cc_smk10_resp_results}
# filter to smoke 10 results
resp_cumulative_results <- cc_dl_int %>% 
  filter(smoke == "smoke10_hms" & type == "cumulative" &
           outcome %in% c("resp", "asthma", "copd") & 
           strata != "smk_basis") %>% 
  mutate(strata = ifelse(strata == "pm_smk_b", "Smoke", "No Smoke"),
    outcome_full = case_when(outcome == "resp" ~ "Respiratory",
                             outcome == "asthma" ~ "Asthma",
                             outcome == "copd" ~ "COPD"),
    out_strata = factor(paste0(outcome_full, "\n ", strata), 
      levels = c("Respiratory\n No Smoke", "Respiratory\n Smoke",
                 "Asthma\n No Smoke", "Asthma\n Smoke",
                 "COPD\n No Smoke", "COPD\n Smoke")))

# plot
plot <- ggplot(resp_cumulative_results, aes(x=time, y=odds_ratio)) +
  geom_line(colour = "#0ed2f7", size = 1) +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), 
              fill = "#b2fefa", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~out_strata, ncol = 2, scales = "free_y") +
  ylab("Odds Ratio: 10 ug/m^3 in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("CC: Respiratory with smoke 10 as effect modifier") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

A couple interesting things could be going on here. On both smoke and non-smoke days, PM~2.5~ may have an effect on respiratory outcome 3 to 4 days following repeated exposure. These lagged curves look similar to me. As for COPD, non-smoke PM~2.5~ follows a similar effect where it may take 3 to 4 days of exposure before an effect is observed. As for smoke PM~2.5~ there may be an effect on the same day that drops off following multiple days of exposure. On the other hand, there may be no association with asthma on non-smoke days, but an association with asthmafollowing 3 to 4 days of exposure. 

When I put this in to context with the comparable results using the time series study design approach, the effect of PM~2.5~ on a smoke day is similar. However, PM~2.5~ on non-smoke days are not similar as the time serieis had results that were inverted. The major difference may be case-crossover being better at accounting for time-invariant confounding, but also, it could be a seasonal thing since I further restricted the time period to compare PM only during wildfire season. I think this may further account for the ways populations may behave during high PM~2.5~ days in the winter, which may be associated with cold days and temperature inverstions that weren't captured by a simple adjustment of temperature. Also, keep in mind this is county-level PM~2.5~ so there is likely misclassification.

```{r dl_cc_smk10_cvd_results}
# filter to smoke 10 results
cvd_cumulative_results <- cc_dl_int %>% 
  filter(smoke == "smoke10_hms" & type == "cumulative" & 
           strata != "smk_basis" &
    outcome %in% c("cvd", "arrhythmia", "cereb_vas", "hf", "ihd")) %>% 
  mutate(strata = ifelse(strata == "pm_smk_b", "Smoke", "No Smoke"),
    outcome_full = case_when(outcome == "cvd" ~ "Cardiovascular",
                             outcome == "arrhythmia" ~ "Arrhythmia",
                             outcome == "cereb_vas" ~ "Cerebrovascular",
                             outcome == "hf" ~ "Heart Failure",
                             outcome == "ihd" ~ "Ischemic Heart Disease"),
    out_strata = factor(paste0(outcome_full, "\n ", strata), 
      levels = c("Cardiovascular\n No Smoke", "Cardiovascular\n Smoke",
                 "Arrhythmia\n No Smoke", "Arrhythmia\n Smoke",
                 "Ischemic Heart Disease\n No Smoke", 
                 "Ischemic Heart Disease\n Smoke",
                 "Heart Failure\n No Smoke", "Heart Failure\n Smoke",
                 "Cerebrovascular\n No Smoke", "Cerebrovascular\n Smoke")))

# plot
plot <- ggplot(cvd_cumulative_results, aes(x=time, y=odds_ratio)) +
  geom_line(colour = "#ff00cc", size = 1) +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), 
              fill = "#ff00cc", alpha = 0.3) + 
  scale_x_continuous(breaks = c(seq(0,7, by=1))) +
  geom_hline(yintercept = 1, linetype = 2, colour = "red") +
  facet_wrap(~out_strata, ncol = 2, scales = "free_y") +
  ylab("Odds Ratio: 10 ug/m^3 in PM2.5") +
  xlab("Lagged Days") +
  ggtitle("CC: Cardiovascular with smoke 10 as a modifier") +
  ryan_theme +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

print(plot)
```

Cardiovascular outcomes are a little less interesting. It looks like there is quite a bit of variance, but it could be interesting given a larger sample size or if we find a way to reduce the variance around estimates. Perhaps a better binary smoke classifier.

## Distribution of PM~2.5~ by Smoke Classifiers

Looking at distribution of PM on smoke and non-smoke days. Starting with the smoke 10 modifier. Limiting the distribution on the high end so it's easier to see.

```{r pm_dist10}
# subset to colorado and washington
co_wa_pm <- county_pm_ts %>%
  filter(state %in% c("Washington", "Colorado")) %>% 
  rename(pm_diff = pm_smk) %>% 
  mutate(smoke10_hms = if_else(pm_diff > 10 & month %in% c(3:11) & hms > 0.1,
                               1, 0),
         smoke15_hms = if_else(pm_diff > 15 & month %in% c(3:11) & hms > 0.1,
                               1, 0))

ggplot(data=co_wa_pm, aes(x=pm_krig, group = as.factor(smoke10_hms), 
                          fill = as.factor(smoke10_hms))) +
  geom_density(alpha = 0.7) +
  facet_wrap(~state) +
  xlim(0, 30) +
  ggtitle("Distribution of PM2.5 by smoke 10") +
  ryan_theme
```

There is some overlap here for Washington where some days that are not necissarily smoke also have high PM~2.5~, suggests that maybe the binary classifier is less-specific than the 15 ug/m^3^ difference cutoff. 

```{r pm_dist15}
ggplot(data=co_wa_pm, aes(x=pm_krig, group = as.factor(smoke15_hms), 
                          fill = as.factor(smoke15_hms))) +
  geom_density(alpha = 0.7) +
  facet_wrap(~state) +
  xlim(0, 30) +
  ggtitle("Distribution of PM2.5 by smoke 15") +
  ryan_theme
```

Less overlap here. Results were pretty similar between smoke 10 and smoke 15 though.

### Conclusions

Using county-level counts of events, there is a suggestion that PM~2.5~ increases on smoke days could be associated with an increased risk of certain respiratory hospitalizations. 

Regarding the cumulative effect plots on non-smoke days, they seem counter-intuitive, but if interpreted as no association, they show me the same thing as distributed lag of PM~2.5~ without the interaction. Perhaps there is somethign to the interaction with smoke? I'm not sure if smoke is an effect modifier of PM~2.5~, but I wonder if we could make the argument that one way to estimate the effect of PM~2.5~ on cardiopulmonary outcomes is to model an interaction? This model here seems to be accounting for binary smoke exposure, and PM~2.5~ exposure without smoke. 

The binary smoke variable indicator did not exhibit lagged effects in these models (I have these estimates but did not plot them). This makes sense to me in the context of effect decomposition/mediation, where I wouldn't expect smoke, accounting for the effect of PM~2.5~, would have an effect on rates of outcomes. Something to discuss.

I'm also exporing these models with time-stratified case-crossover designs as well to confirm.

#### Notes and Next Steps: 

- I presented interactions for cutoffs of 10 and 15, but this introduces some bias to our research question of what is the impact of PM~2.5~ on smoke vs non-smoke days, where I've possibly included days impacted by light smoke or even moderate smoke as PM days not impacted by smoke. I have days using HMS only as a day impacted by smoke and the shapes are a bit different. This raises a further gap in the literature on how to classify counties where a good deal of the population was affected by smoke. 

- County-level population-weigthing is probably subject to a higher degree of misclassification compared to ZIP level, but we only have county-level information on mortality and I see value to keep it at the same spatial unit. 

- I would like to go back and try and define a county impacted by smoke. This would let us look at interactions between continuous PM~2.5~ due to smoke and due to other sources.I need to chat with Bonne, Kate, Jeff, and Emily.

- Work with Rish and run associations with mortality data; pilot with Colorado mortality data.

- I will try another time-stratified case-crossover to confirm results here. I need to think about referent period. I think with two states and multiple years, I can shorten the referent periods to maybe a month.

- Oregon results seemed a little wonky and noisy and I'm not sure I want to include them here since the all payers all claims dataset had some nuances and may yield a different population relative to what we got for Colorado and Washington.



